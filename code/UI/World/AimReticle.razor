@namespace Grubs.UI

@using Grubs.Equipment.Weapons
@using Grubs.Extensions
@using Grubs.Pawn
@using Grubs.Systems.Pawn.Grubs
@using Sandbox;
@using Sandbox.UI;
@using Sandbox.Utility

@inherits PanelComponent

<root>
    <div class="reticle bg-@Grub.Owner.PlayerColor.ToString()-light" />
</root>

@code
{
    [Property] public Grub Grub { get; set; }

    private Color Color => Color.Parse("#FFFFFF") ?? Color.Black;

    protected override void OnStart()
    {
        WorldRotation = WorldRotation.RotateAroundAxis(Vector3.Up, 90f);
    }

    private bool IsShowing()
    {
        if (!GameObject.Root.Components.TryGet<Grub>(out var grub))
            return false;

        if (!grub.IsActive)
            return false;

        if (!grub.PlayerController.ShouldShowWeapon())
            return false;

        if (!grub.ActiveEquipment.IsValid())
            return false;

        if (!grub.ActiveEquipment.ShouldShowAimReticle)
            return false;

        return true;
    }

    protected override void OnUpdate()
    {
        var isShowing = IsShowing();
        SetClass("hidden", !isShowing);

        if (!isShowing)
            return;

        if (!Grub.ActiveEquipment.IsValid())
            return;

        if (!Grub.ActiveEquipment.Components.TryGet<Weapon>(out var weapon))
            return;
        
        var pos = weapon.GetMuzzleTransform().Position;
        pos += weapon.GetMuzzleForward() * 48f;

        WorldPosition = pos;
        WorldRotation = WorldRotation.RotateAroundAxis(Vector3.Forward, 0.25f);
    }
}